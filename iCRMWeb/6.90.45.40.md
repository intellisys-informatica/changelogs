# ICRMWeb

# :file_folder: 6.90.45.40

## :memo: O que foi alterado?

<details open>
<summary>Resumo</summary>

- :arrow_up: **PAGE_TableCampanha** (13/08/2025):
  - Os botões `Sorteios` e `Prêmios` agora estão abrindo as páginas corretas
  - O botão `Gerar Nro Sorte` agora não executa nenhuma ação se o parâmetro `PARNUMEROSORTECORRETORA` estiver ativo
  - Os botões nessa tela voltaram a respeitar o template de restrição
  - Ajuste para exibir a descrição correta da campanha nova `46 - Premiação no PDV`

- :star: **PAGE_FormCampanha** (13/08/2025):
  - Criada nova campanha `46 - Premiação no PDV`

- :arrow_up: **PAGE_FilterCampanha** (13/08/2025):
  - Adicionada a nova campanha `46 - Premiação no PDV` no combo de tipo

- :arrow_up: **PAGE_LiberaCuponsDescontoImportacao** (13/08/2025):
  - Importação de cupons de desconto semelhante à campanha 38

- :arrow_up: **PAGE_ViewCupDescontos** (14/08/2025):
  - Botão novo `Entrega` para entregar o cupom de desconto sorteado no PDV

- :star: **PAGE_FormEntregaCupDesconto** (14/08/2025):
  - Tela nova para dar baixa nos cupons de desconto sorteados pelo PDV

</details>

:star: Novo
:warning: Correção
:arrow_up: Melhoria

<details open>
<summary>Detalhes</summary>

:arrow_up: Ajustes na campanha 39 (Solicitação 4444)

Foi solicitado que a campanha 39 se comporte de forma idêntica à campanha 22. Para isso, foram ajustados os botões `Sorteios` e `Prêmios` para terem o mesmo comportamento da campanha 22.

Além disso, no botão `Gerar Nro Sorte`, foi adicionada uma verificação no parâmetro `PARNUMEROSORTECORRETORA`. Caso ele esteja ativo, a seguinte mensagem é exibida:

> `"O método de geração e associação de números da sorte é de responsabilidade da Corretora."`

:arrow_up: Correção no template de restrição (Solicitação 4607)

Recentemente houve um ajuste na visualização dos botões na `PAGE_TableCampanha`, porém não atentamos ao funcionamento do template de restrição. Nesta versão, os botões desta página voltaram a respeitar o template de restrição.

:star: Nova campanha 46 - Premiação no PDV

Foi criada uma nova campanha, a `46 - Premiação no PDV`, uma campanha de sorteio de cupons de desconto liberada no momento da compra no PDV. Ela é atrelada a uma campanha 24 que é responsável por gerar os cupons que serão sorteados na campanha 46, similar às campanhas 7, 38 e 40. Em um horário específico é liberado um cupom de desconto e o primeiro cliente a comprar ganha esse cupom.

Para isso, alteramos:
- O filtro para exibir essa opção nova
- A tabela para se comportar de forma semelhante à campanha 38
- O formulário para conter os campos necessários para essa campanha funcionar

:star: Página de entrega de cupons sorteados

Após o cliente ganhar, será necessário entregar o cupom de desconto. Na página `PAGE_ViewCupDescontos` (**Fidelização>Processos>Campanhas:Cupom Desconto**) criamos um botão novo chamado `Entrega` que chama uma nova página `PAGE_FormEntregaCupDesconto` para realizar a entrega ao cliente, associando ao CPF ou a um cartão padrão configurado no parâmetro `PARCARTAOPADRAOCUPSORTEIO`. Lembrando que esse cartão não precisa existir em nosso sistema, podendo ser um cartão externo.

</details>

## :cd: Banco de dados

Não houve alteração no banco de dados.

<details open>
<summary>Resumo</summary>
</details>

<details open>
<summary>Detalhes</summary>
</details>

<details open>
<summary>Scripts</summary>
</details>

## :wrench: Configurações necessárias

### Configuração da Campanha 46 - Premiação no PDV

Para configurar a campanha `46 - Premiação no PDV`, siga os passos:

1. Criar uma nova campanha do tipo 46
2. Inserir a descrição
3. Informar a mala direta (caso necessário)
4. Definir a data de início e a data de fim
5. Informar a data de fim da troca de cupom (equivalente ao encerramento da campanha)
6. Definir o valor mínimo para ter a chance de ganhar um cupom de desconto
7. Configurar a quantidade de dias para o fim da campanha — ou seja, quantos dias após o encerramento ainda será possível comprar e usar o cupom (caso necessário)
8. Informar a quantidade máxima de cupons de desconto que será gerada pela campanha 24
9. Definir o valor mínimo da compra para usar o cupom de desconto (caso necessário)
10. Informar a soma total de descontos equivalente ao valor máximo que poderá ser gerado pela campanha 24 (caso necessário)
11. Inserir o rodapé que será impresso no cupom de desconto (caso necessário)
12. Após confirmar, na página da tabela de campanha clicar em `Processar Campanha`. Nesse momento será criada a campanha 24
13. Após processar campanha, importar um arquivo com os cupons de desconto com os horários de sorteio, clicando em `Importar Cupom Desconto`

### Arquivo de Importação

O arquivo de importação deve ser um `.xls/.xlsx` com as seguintes colunas:

| LOJA | VALOR (R$) | QUANTIDADE | DATA | HORA INÍCIO | HORA FIM | HORA SORTEIO |
|---|---|---|---|---|---|---|

Os títulos das colunas são validados para considerar um arquivo válido.

**Descrição das colunas:**
- **LOJA** - Número da loja onde o cupom de desconto será sorteado
- **VALOR (R$)** - O valor do cupom de desconto
- **QUANTIDADE** - Quantidade de cupons de desconto que será liberado nessa configuração
  - Normalmente se coloca 1, porém existe a possibilidade de geração aleatória, onde se informa a quantidade, o dia e a hora de início e fim. Dessa forma os cupons receberão aleatoriamente um horário de liberação
- **DATA** - Dia em que os cupons serão liberados
- **HORA INÍCIO** - Funciona juntamente com a `HORA FIM` para determinar um horário aleatório para a liberação do cupom de desconto
- **HORA FIM** - Funciona juntamente com a `HORA INÍCIO` para determinar um horário aleatório para a liberação do cupom de desconto
- **HORA SORTEIO** - Determina a hora exata do sorteio, desprezando a informação da `HORA INÍCIO` e `HORA FIM`

### Parâmetro PARCARTAOPADRAOCUPSORTEIO

Para utilizar um cartão padrão na página de entrega de cupom de sorteio (`PAGE_FormEntregaCupDesconto`), é necessário configurar o parâmetro `PARCARTAOPADRAOCUPSORTEIO` com um cartão que não precisa existir em nosso sistema. Ele só servirá para facilitar a busca por cupons entregues.