# iCRMWeb

# :file_folder: 06.92.48.00

*Atualizado em: 05/11/2025*

## :memo: O que foi alterado?

<details open>
<summary>Resumo</summary>

Esta versão contém 125 atualizações abrangendo:

### Correções :warning:
- Correção de erro no evento comunicado automático tipo 32
- Ajuste em totalizadores de relatório de estatísticas de descontos
- Correção de retorno de comunicação ao responder fale conosco via push
- Correção de erro no painel de fidelização
- Correção de sentença em painel de frequência
- Correção de chave duplicada em LogsApiHistorico
- Correção de erro na escrita do log do SenderService
- Correção de push com status 3 (erro no processamento)
- Correção de erro ao abrir fatura no app Brasil
- Correção no banner do WebCliente
- Correção de notificações duplicadas
- Correção de erro ao consultar por classificação no painel fidelização

### Novas Funcionalidades :star:
- Implementação de integração de envio de email com Zenvia
- Implementação de integração de envio de SMS com Twilio e SendPulse
- Implementação de integração de email com MailerSend
- Nova campanha tipo 39: Número da Sorte por Produtos
- Nova campanha tipo 46: Cupons de desconto com restrições
- Implementação de estatísticas para campanhas Game (tipos 38 e 40)
- Controle/Restrições por usuário/grupo para tipos de campanha
- Evento comunicado automático 42: Registra Fatura Banco via Integração (TecnoSpeed)
- Evento comunicado automático 43: Consulta Fatura Banco via Integração
- Webhook TecnoSpeed para processamento de boletos
- Webhook PontalTec
- Inserção e envio de boletos em lote via integração
- Melhoria na view de cupons de descontos com novos filtros
- Baixa de cupom de desconto por CPF/Cartão
- Relatório de acessos de clientes ao iCRM Mobile
- Ativação automática de oferta em campanhas

### Melhorias :arrow_up:
- Ajustes em telas do aplicativo Jacomar (Android e iOS)
- Ajustes em telas do aplicativo Mais Barato
- Ajustes em telas do aplicativo Brasil
- Ajustes em telas do aplicativo Solzão
- Ajustes no WebCliente Jacomar (correção de sincronização Ajax)
- Ajustes no WebCliente Ourinhos (ofertas)
- Criação do WebCliente Solzão
- Ajustes na tela de texto diverso
- Ajuste de login no app Jacomar para clientes sem email/celular
- Ajustes na geração de arquivo de cobrança
- Melhoria na rotina de envio de Push Notification
- Ajuste na tela de cartões (exibir mesmo com saldo insuficiente)
- Aprimoramento de SEO no WebCliente PinClube
- Sincronização de email entre App e WebCliente

### Infraestrutura :gear:
- Criação de instalação Docker para Hotsite Meu Costume
- Limpeza automática de LogDiversos, WsRequisicoes e WsAplLogToken
- Transferência de webhook para infraestrutura Jacomar
- Aplicação de novos objetos no banco de dados
- Cadastro de conexão BD

### Publicações de Aplicativos :iphone:
- **Jacomar iOS**: Versões 12.90.46.40, 12.91.47.20, 12.91.47.21, 12.91.47.29, 12.91.47.30
- **Jacomar Android**: Múltiplas atualizações
- **Mais Barato iOS**: Versões 12.88.45.10 e atualizações posteriores
- **Mais Barato Android**: Publicação para teste interno
- **Brasil iOS**: Versão 12.90.45.10 e atualizações
- **Solzão iOS**: Versão 12.91.47.11

### Treinamento e Documentação :books:
- Treinamento Linguagem W LP1
- Treinamento WinDev (I, II, III e IV)
- Treinamento WebDev
- Tutorial WebDev
- Projeto EstruturaBD (WinDev)
- Projeto IFerias

</details>

## :cd: Detalhes das Principais Alterações

### Integrações Bancárias e Boletos

#### Integração TecnoSpeed (PlugBoleto)
Implementada integração completa com TecnoSpeed para emissão e gestão de boletos:

**Novos Campos em ConfigBoletoIntegracao:**
- CFGINTCnpjSH
- CFGINTTokenSH
- CFGINTDescricao
- CFGINTRazaoSocial / NomeFantasia
- CFGINTCPFCNPJ / Telefone / Email
- CFGINTCedenteToken / IdConta
- Dados bancários completos (Banco, Agência, Conta, Carteira, etc.)
- Configurações de baixa automática

**Eventos Criados:**
- **Evento 42**: Registra Fatura Banco Via Integração
- **Evento 43**: Consulta Fatura Banco Via Integração

**Webhook Implementado:**
O webhook `pgWebHookTecnoSpeed` trata os seguintes status:
- **Registrado**: Atualiza status para 5
- **Liquidado**: Atualiza status para 6 + lança movimento de pagamento
- **Baixado**: Atualiza status para 7 + lança ocorrência tipo 609
- **Rejeitado**: Atualiza status para 8 + envia email para responsáveis

**Parâmetros Gerais:**
- PARSOFTHOUSETOKEN
- PARSOFTHOUSECNPJ

### Integrações de Comunicação

#### SendPulse (SMS)
- Procedure criada: `pSendPulse_EnviaSMS`
- Nota: SendPulse não oferece webhook de retorno

#### Twilio (SMS)
- Integração disponível no projeto ICRMHotSite
- Objetos prontos para comunicação

#### Zenvia (Email)
- Integração de envio de email implementada

#### MailerSend (Email)
- Integração de envio de email implementada

### Campanhas

#### Campanha Tipo 39 - Número da Sorte por Produtos
- Botão "Sorteios" funciona como campanha 22
- Botão "Prêmios" ajustado para funcionar com campanha 39
- Botão "Gerar Nro Sorte" verifica parâmetro de ativação
- Implementado no WebCliente PinClube para consulta de números

#### Campanha Tipo 46 - Cupons com Restrições
Configurações no ICRM3:
- Criação da campanha 46 em `PAGE_FormCampanha`
- Filtro de pesquisa em `PAGE_TableCampanha`
- Possibilidade de adicionar lojas
- Geração automática de campanha 24 atrelada
- Importação de arquivo de cupons com layout específico

Tela de Baixa de Cupom (`PAGE_FormEntregaCupDesconto`):
- Entrega por CPF
- Entrega por Cartão Padrão
- Entrega por Cartão Externo
- Insere em `ConsultaPromocao` e `ConsultaPromocaoCups`
- Atualiza `CupPromocao`

Ajustes realizados:
- Melhorias na view de cupons (filtros por loja, períodos, disponibilidade)
- Exibição de loja, data sorteio, CPF, celular, email, data utilização

### Controle de Acesso e Restrições

#### Restrições por Usuário/Grupo
**Banco de Dados:**
```sql
ALTER TABLE MENUUSUARIO ADD mnusrcamdescontosrestritos VARCHAR2(200);
ALTER TABLE MENUGRUPO ADD mngrpcamdescontosrestritos VARCHAR2(200);
```

**Funcionalidades:**
- Popup de lista de campanhas para restrição em `PAGE_FormMnUsuario` e `PAGE_FormMnGrupo`
- Validação em `PAGE_FormCampanha` que impede inserir/alterar campanhas restritas
- Controle granular por usuário ou grupo

### Aplicativos Mobile

#### Jacomar
**Ajustes Android e iOS:**
- Reformulação do menu lateral
- Correção de erro ao cadastrar no totem
- Ajuste no fluxo de login para clientes sem email/celular
- Recuperação de senha com validação por data de aniversário
- Parâmetro: `HSITEAVISOATUALIZACONTATOSFUNC` para funcionários
- Correção de erro "Internal Windows"
- Ajuste de cadastro no iOS
- Múltiplas atualizações e correções

**Alterações no WebCliente:**
- Correção de problema de sincronização (botões em modo Ajax)
- Ajustes em telas de troca e recuperação de senha (uso de token)

#### Mais Barato
- Atualização de logo no aplicativo
- Publicação Android para teste interno
- Imagens geradas para loja iOS (disponíveis em `T:\Daniel\Banner APP MaisBarato`)
- Múltiplas publicações iOS

#### Brasil
- Correção de erro ao abrir fatura
- Múltiplas publicações iOS

#### Solzão
**Novo Aplicativo:**
- Criação do app Solzão
- Criação do WebCliente Solzão (duplicado do Ourinhos com layout reformulado)
- Ajustes gerais no app
- Publicação iOS versão 12.91.47.11
- Imagens geradas (disponíveis em `\\192.168.16.253\Transferencia\Daniel\Solzao\Dimensoes JPG`)

#### AmCash Card
- Alterações nas telas do aplicativo
- Necessário alterar splash ao gerar apps

#### Sumerbol
- Ajuste na tela de cartões (WS Nuvem Android)

### Melhorias Gerais

#### Push Notifications
- Melhoria na rotina de envio (`SET_GlobalProcedures.pgEnviaNotificacao` no SenderService)
- Alteração em `AgendaMensagem.InserirNotApp` no CRMImpressor
- Correção de protocolo de comunicação (atualização para versão recente do WinDev)
- Correção de notificações duplicadas
- Parâmetro: `PARDESABILITAPUSHSENDERSERVICE` (valor 1 desativa)

#### Relatórios e Estatísticas
- Ajuste em RPT_PromoCupDescLoja (verificação `Cnsproclicodigo > 1`)
- Correção de IF que não adicionava número da campanha ao select
- Nova página: `PAGE_ViewEstatisticasCampanhaGame` para campanhas 38 e 40
- Filtros: Campanha, Período Chance (Cadastro/Utilização), Período Prêmio (Cadastro/Liberação), Cliente
- Relatório de acessos de clientes ao iCRM Mobile

#### Limpeza e Manutenção
Procedures criadas para limpeza automática:
- `pgLimpezaLogdiversos()`
- `pgLimpezaWsRequisicoes()`
- `pgLimpezaWsapllogToken()`

Regras de limpeza conforme solicitação.

#### Cartões e Pagamentos
- Ajuste para exibir cartões mesmo com saldo insuficiente (não autoriza pagamento)
- Remoção de "Pagar Fatura com PIX" (codificação PIX)
- Ajustes na geração de arquivo de cobrança (cálculo de juros diários)

#### Macrosubstituição
- Ajuste em `pgMacroSubTxtDiverso`
- Tag `DEP_DEPTOKENRECUPERARSENHA` usa token decriptografado

#### Sincronização App/WebCliente
- Email apagado no WebCliente quando apagado no App
- Necessário gerar e atualizar WebCliente

#### Ofertas e Parcelamento
- Implementação de ativação automática de oferta em campanhas
- Flag "Ativação de oferta" em `PAGE_FormCampanha`
- Criação automática de mala direta vinculada à campanha
- Ofertas no Portal Ourinhos implementadas

### Correções Específicas

#### Evento 32 (CRMImpressor)
- Ajuste na classe `AgendaMensagem`
- Adicionado replace no método `mCapturaParametros`
- Necessário gerar CRMImpressor

#### Fatura Paga no App
- Ajuste para não mostrar fatura na tela Home quando quitada

#### Painel Fidelização
- Correção de sentença de carregamento
- Correção ao consultar por classificação

#### Painel Frequência
- Análise de divergências entre Painel e Relatório de Clientes por Frequência

#### Comunicação com Clientes
- Correção de comunicações com código e nome de clientes em branco

#### Oferta de Parcelamento
- Análise: HIPER MOREIRA utiliza envio de email (não mais gráfica)
- Validação: Tipo Negociação OK + Parâmetro PAROFERTAACORDOFATURA OK

### Infraestrutura e DevOps

#### Docker
- Criação de imagem Docker para Hotsite Meu Costume (Linux)
- Pronto para servidor nuvem

#### Webhooks
- Webhook TecnoSpeed implementado em WSICRMREST
- Webhook PontalTec implementado
- Transferência para infraestrutura Jacomar

### Projetos e Treinamento

#### EstruturaBD (WinDev)
Aplicativo desktop para gerenciar objetos de banco:
- Cadastro de Tabelas, Colunas, Gatilhos, Procedures, Visões, Sequências
- Controle de versionamento
- Filtros por nome, data e versão
- Uso de Analysis, POO, data binding e relacionamentos

Etapas concluídas:
1. Estrutura BD
2. Classes orientadas a objetos
3. Telas funcionais
4. Funcionalidades unificadas
5. Testes de banco

#### IFerias
Projeto I (IFerias) desenvolvido

#### Treinamentos Realizados
- 02 Treinamento Linguagem W LP1
- 03 Treinamento WinDev (I)
- 04 Treinamento WinDev (II)
- 05 Treinamento WinDev (III)
- 06 Treinamento WinDev (IV)
- Tutorial WebDev (múltiplas sessões)

### Publicações de Versões

#### iCRM3/iCRMWeb
- Versão 12.91.46.00 (Jacomar)
- Versão 12.91.46.20 (Jacomar)
- Versão 12.91.46.30 (Jacomar)

### Outros Ajustes

#### Intellisys
- Rotina de consulta criada
- Ajustes gerais

#### Clube da Economia Jacomar
- Implementação realizada

#### SEO WebCliente PinClube
- Aprimoramento de SEO para destaque nos resultados do Google

#### Documentos na Tarefa
- Frontend implementado (1/4)

#### Mobile Mensagem
- Inserção de Mobile Mensagem implementada

## :wrench: Configurações necessárias

### Parâmetros Novos

**PARSOFTHOUSETOKEN**
- Token para integração TecnoSpeed/PlugBoleto

**PARSOFTHOUSECNPJ**
- CNPJ para integração TecnoSpeed/PlugBoleto

**PARDESABILITAPUSHSENDERSERVICE**
- Valor: `1` desativa o envio de Push Notification pelo SenderService

**HSITEAVISOATUALIZACONTATOSFUNC**
- Mensagem exibida para funcionários ao atualizar contatos no app Jacomar

**PAROFERTAACORDOFATURA**
- Controle de oferta de parcelamento em fatura

### Configurações de Integração

#### TecnoSpeed (PlugBoleto)
Acessar `PAGE_FormConfigIntegracao` e preencher:
- **URL**: Endpoint da API (ex: `https://homologacao.plugboleto.com.br/api/v1`)
- **ID**: token-sh (ex: `f22b97c0c9a3d41ac0a3875aba69e5aa`)
- **Secret**: cnpj-sh (ex: `01001001000113`)
- **Descrição**: Nome identificador da configuração
- Dados do cedente (Razão Social, CNPJ, Telefone, Email)
- Dados bancários (Banco, Agência, Conta, Carteira, etc.)
- Configurações de baixa automática

#### Eventos Comunicados Automáticos
Configurar em `PAGE_FormEComAutomaticos`:
- **Evento 42**: Registra Fatura Banco Via Integração
- **Evento 43**: Consulta Fatura Banco Via Integração

### Restrições de Campanhas
Configurar restrições por usuário/grupo em:
- `PAGE_FormMnUsuario` - Popup de campanhas restritas
- `PAGE_FormMnGrupo` - Popup de campanhas restritas

### Campanhas

#### Campanha Tipo 39
- Parâmetro para ativar/desativar geração de número da sorte
- Configuração em WebCliente PinClube

#### Campanha Tipo 46
- Criar campanha 46 em `PAGE_FormCampanha`
- Adicionar lojas
- Gerar campanha 24 atrelada
- Importar arquivo de cupons (usar botão de layout)

### Aplicativos

#### Jacomar
- Parâmetro `HSITEAVISOATUALIZACONTATOSFUNC` deve estar configurado

#### AmCash Card
- Alterar splash ao gerar aplicativos

### WebClientes
Após deploy, reiniciar aplicações:
- WebCliente Jacomar
- WebCliente Ourinhos
- WebCliente Solzão (novo)

### Serviços

#### CRMImpressor
Necessário gerar nova versão:
- Ajustes em `AgendaMensagem` (Evento 32)
- Ajustes em `InserirNotApp` (Push Notification)

#### SenderService
Necessário gerar nova versão:
- Ajustes em `SET_GlobalProcedures.pgEnviaNotificacao`
- Parâmetro `PARDESABILITAPUSHSENDERSERVICE`

### Banco de Dados

#### Scripts a Executar
```sql
-- Restrições de campanhas
ALTER TABLE MENUUSUARIO ADD mnusrcamdescontosrestritos VARCHAR2(200);
ALTER TABLE MENUGRUPO ADD mngrpcamdescontosrestritos VARCHAR2(200);

-- Campos de integração TecnoSpeed
ALTER TABLE CONFIGBOLETOSINTEGRACAO ADD (
    CFGINTCnpjSH VARCHAR2(20),
    CFGINTTokenSH VARCHAR2(200),
    CFGINTDescricao VARCHAR2(200),
    CFGINTRazaoSocial VARCHAR2(200),
    CFGINTNomeFantasia VARCHAR2(200),
    CFGINTCPFCNPJ VARCHAR2(20),
    CFGINTTelefone VARCHAR2(20),
    CFGINTEmail VARCHAR2(100),
    CFGINTCedenteToken VARCHAR2(200),
    CFGINTIdConta VARCHAR2(100),
    CFGINTBanco VARCHAR2(10),
    CFGINTAgencia VARCHAR2(10),
    CFGINTAgenciaDV VARCHAR2(2),
    CFGINTContaNumero VARCHAR2(20),
    CFGINTContaNumeroDV VARCHAR2(2),
    CFGINTContaTipo VARCHAR2(20),
    CFGINTCodigoBeneficiario VARCHAR2(50),
    CFGINTCodigoEmpresa VARCHAR2(50),
    CFGINTConvenioNumero VARCHAR2(50),
    CFGINTCarteira VARCHAR2(10),
    CFGINTBaixaAutomatica NUMBER(1),
    CFGINTDiasBaixaAutomatica NUMBER(3)
);
```

### Menu do Sistema
Cadastrar nova tela no menu:
- `PAGE_ViewEstatisticasCampanhaGame` - Estatísticas de campanhas Game

### Testes Recomendados

1. **Integração TecnoSpeed**:
   - Criar configuração de integração
   - Inserir boleto em lote
   - Enviar remessa em lote
   - Validar webhook (registrado, liquidado, baixado, rejeitado)

2. **Campanha Tipo 39**:
   - Criar campanha 39
   - Gerar números da sorte
   - Testar visualização no WebCliente (CPF teste: 05181483518, senha: 123456)

3. **Campanha Tipo 46**:
   - Criar campanha 46
   - Adicionar lojas
   - Gerar campanha 24 atrelada
   - Importar cupons
   - Testar baixa de cupom (CPF, Cartão Padrão, Cartão Externo)

4. **Restrições de Campanhas**:
   - Configurar restrição por usuário
   - Configurar restrição por grupo
   - Validar bloqueio ao tentar alterar campanha restrita

5. **Aplicativos**:
   - Testar login Jacomar sem email/celular
   - Testar recuperação de senha
   - Validar sincronização de email App/WebCliente
   - Testar exibição de cartões com saldo insuficiente

6. **Push Notifications**:
   - Validar envio via SenderService
   - Testar parâmetro de desativação
   - Verificar ausência de notificações duplicadas

7. **Estatísticas Campanhas Game**:
   - Acessar via menu
   - Acessar via botão em `PAGE_TableCampanha`
   - Testar filtros (Campanha, Períodos, Cliente)

## :cd: Banco de dados

Executar scripts de alteração de estrutura mencionados na seção "Configurações necessárias".

---

**Total de tarefas documentadas**: 125
**Sistemas atualizados**: iCRMWeb, CRMImpressor, SenderService, WebClientes (Jacomar, Ourinhos, Solzão), Aplicativos Mobile (Jacomar, Mais Barato, Brasil, Solzão, AmCash Card)
