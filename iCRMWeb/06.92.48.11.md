# ICRMWeb

# :file_folder: 6.92.48.11

## :memo: O que foi alterado?

<details open>
<summary>Resumo</summary>

- :star: Integração com a TecnoSpeed
  - **PAGE_FormConfigIntegracao**
- :star: Evento comunicado automático novo `42 - Registra fatura banco via integração`
- :star: Evento comunicado automático novo `43 - Consulta fatura banco via integração`
  - **PAGE_FormEComAutomaticos**
  - **PAGE_TableEComAutomaticos**
- :star: Integração com a Zenvia para envio de email
  - **PAGE_FormParametrosEmailSmsUra** (20/08/2025)
- :star: Restrição de tipo de campanha por usuário e grupo de usuário
- :star: Funcionalidade de ativação de oferta em campanhas
- :star: Implementação de integração de envio de SMS com Twilio
- :star: Implementação de integração de envio de SMS e email com PontalTech
- :warning: Correção de erro no painel de fidelização
- :arrow_up: Melhoria na rotina de envio de Push Notification
</details>

:star: Novo
:warning: Correção
:arrow_up: Melhoria

<details open>
<summary>Detalhes</summary>

:star: Integração com a TecnoSpeed

Adicionada uma nova integração com a TecnoSpeed para a geração de arquivo para o banco, geração de boleto e PIX. Essa integração automatiza a parte de geração, envio e retorno do banco das faturas dos clientes, fornecendo linha digitável e QRCode para PIX.

:star: Evento comunicado automático novo `42 - Registra fatura banco via integração`

Esse processo é automatizado no nosso sistema através de um evento automático novo, o `42 - Registra fatura banco via integração`, que roda diariamente buscando faturamento executado no dia anterior a quantidade de dias após o fechamento do faturamento definido no parâmetro do evento `Quantidade de dias para o envio do arquivo após o fechamento do faturamento`, registrando as faturas no TecnoSpeed e registrando altomaticamente no banco via api. O retorno será feito via webhook assim que a TecnoSpeed informar o pagamento do boleto.

:star: Evento comunicado automático novo `43 - Consulta fatura banco via integração`

Periodicamente é necessário consultar o status dos boletos no TecnoSpeed. Criamos o evento `43 - Consulta fatura banco via integração` para consultar todos os boletos que estão marcados com os seguintes status:

- 0 - Criado
- 1 - Salvo
- 3 - Emitido
- 4 - Remessa
- 5 - Registrado
- 9 - Pendente Retentativa

Esses status são da tabela `FatClienteIntegração` na coluna `FatIntFlagIntegracao`.

**Outros status (não consultados):**

- 2 - Falha
- 6 - Liquidado
- 7 - Baixado
- 8 - Rejeitado

As faturas que estão nesses outros status não são mais consultadas, porque houve algum erro ou foram finalizadas.

:star: Integração com a Zenvia para envio de email

O sistema está integrado com a API do Zenvia para envio de email sem anexo. Devido à regra do Zenvia onde o arquivo em anexo deve ser informado como link, e por ainda não termos uma alternativa de hospedagem de documento, essa rotina não suporta anexo por enquanto.

:star: Restrição de tipo de campanha por usuário e grupo de usuário

Agora é possível restringir quais tipos de campanha um usuário/grupo pode inserir ou alterar. Na página de alteração de um usuário temos agora a opção `Restringir Campanhas`, que permite restringir os tipos de campanha. O que estiver marcado não permitirá o usuário/grupo inserir ou alterar campanhas desse tipo. No caso da inserção, o tipo restrito nem aparece no combobox para ser selecionado.

:star: Implementação de integração de envio de SMS com Twilio

O sistema está integrado com a API do Twilio para envio de sms. COnfigurável pala tela de parâmetros so sender.

**Como funciona:**

Nas campanhas dos tipos específicos, foi adicionada uma opção para indicar se essa campanha vai exigir a ativação da oferta. Quando essa flag for ativada:

- Uma mala direta vazia será gerada automaticamente (obrigatório ter uma mala na campanha quando o flag estiver ativado)
- No aplicativo mobile, aparecerá um botão para `ativar todas as ofertas`
- Quando o cliente clicar nesse botão, ele será adicionado automaticamente na mala direta da campanha

Essa funcionalidade permite que os clientes ativem ofertas sob demanda através do aplicativo mobile, sendo automaticamente incluídos na campanha correspondente.

:warning: Correção de erro no painel de fidelização

Quando

:arrow_up: Melhoria na rotina de envio de Push Notification

Agora a tabela de mobileMensagem é autossuficiente, possui todos os campos necessários para enviar o push Notification, pra isso foi necessário adicionar uma coluna de destino outra para agrupar disparo, pois uma mensagem agora pode ser enviada para vários tokens do mesmo cliente, gerando várias mensagens, o icrm exibirá apenas uma mensagem do agrupamento, priorizando a mensagem que deu certo.

Foi alterado também o campo que será enviado no corpo da mensagem da notificação, paramos de utilizar o campo `Corpo da notificação` e passamos a utilizar o campo `Corpo`, com isso os textos diversos antigos devem ser migrados para esse novo campo, na tela de texto diverso quando o campo antigo está preenchido é exibido uma mensagem se deseja migrar o conteudo para o campo novo, e o campo antigo deixa de ser exibido.

</details>

## :cd: Banco de dados

<details open>
<summary>Resumo</summary>

- Colunas novas em CONFIGBOLETOSINTEGRACAO
- Colunas novas em MENUUSUARIO
- Colunas novas em MENUGRUPO
- Coluna nova em MobileMensagem

</details>

<details open>
<summary>Detalhes</summary>

**CONFIGBOLETOSINTEGRACAO**

Foram adicionadas colunas novas necessárias para integrar com a TecnoSpeed. As colunas novas auxiliam na geração de boleto via PlugBoleto da TecnoSpeed.

**MENUUSUARIO e MENUGRUPO**

Colunas novas para armazenar as restrições por tipo de campanha por usuário e por grupo de usuário.

**MobileMensagem**

Colunas novas para armazenamento de informações para tornar a tabela autossuficiente

</details>

<details open>
<summary>Scripts</summary>

**CONFIGBOLETOSINTEGRACAO**
alter table CONFIGBOLETOSINTEGRACAO add cfgintnomefantasia VARCHAR2(40);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcpfcnpj NUMBER(18);
alter table CONFIGBOLETOSINTEGRACAO add cfginttelefone VARCHAR2(15);
alter table CONFIGBOLETOSINTEGRACAO add cfgintemail VARCHAR2(100);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcedentetoken VARCHAR2(256);
alter table CONFIGBOLETOSINTEGRACAO add cfgintidconta NUMBER(10);
alter table CONFIGBOLETOSINTEGRACAO add cfgintbanco NUMBER(5);
alter table CONFIGBOLETOSINTEGRACAO add cfgintagencia VARCHAR2(20);
alter table CONFIGBOLETOSINTEGRACAO add cfgintagenciadv VARCHAR2(20);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcontanumero VARCHAR2(20);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcontanumerodv VARCHAR2(20);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcontatipo VARCHAR2(20);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcodigobeneficiario NUMBER(10);
alter table CONFIGBOLETOSINTEGRACAO add cfgintconvenionumero NUMBER(18);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcarteira NUMBER(5);
alter table CONFIGBOLETOSINTEGRACAO add cfgintbaixaautomatica NUMBER(3);
alter table CONFIGBOLETOSINTEGRACAO add cfgintdiasbaixaautomatica NUMBER(5);
alter table CONFIGBOLETOSINTEGRACAO add cfgintidCedente NUMBER(10);
alter table CONFIGBOLETOSINTEGRACAO add cfgintbairro VARCHAR2(80);
alter table CONFIGBOLETOSINTEGRACAO add cfgintnumero NUMBER(10);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcomplemento VARCHAR2(80);
alter table CONFIGBOLETOSINTEGRACAO add cfgintcidadeibge NUMBER(18);
alter table CONFIGBOLETOSINTEGRACAO add cfgintidConvenio NUMBER(10);
alter table CONFIGBOLETOSINTEGRACAO add cfgintdescricao VARCHAR2(40);
alter table CONFIGBOLETOSINTEGRACAO add cfgintwebhook VARCHAR2(200);
alter table CONFIGBOLETOSINTEGRACAO add cfgintwebhookAtivo NUMBER(3);
alter table CONFIGBOLETOSINTEGRACAO add cfgintEmailsNotificacao VARCHAR2(512);
alter table CONFIGBOLETOSINTEGRACAO add cfgintapikey varchar2(512);

**MENUUSUARIO**
alter table MENUUSUARIO add mnusrcamdescontosrestritos varchar2(200);

**MENUGRUPO**
alter table MENUGRUPO add mngrpcamdescontosrestritos varchar2(200);

**MOBILEMENSAGEM**
ALTER TABLE MOBILEMENSAGEM add(mobmsgtokendestino VARCHAR(255),
                                mobmsgagrupamento VARCHAR(36),
                                mobmsgconteudoextra VARCHAR2(4000),
                                mobmsgtiposistema NUMBER(10));
</details>

## :wrench: Configurações necessárias

### Configuração TecnoSpeed

1. **Atualizar Objetos**
   - ICRMWeb:
     - PAGE_FormParametrosEmailSmsUra
   - SenderService
   - WebServicesREST

2. **Parametros Gerais**
	**Configurações > Parâmetros > Parâmetros Gerais**

	Inserir os parâmetros:
	**PARSOFTHOUSECNPJ** - CNPJ da Intellisys = 03850063000125
	**PARSOFTHOUSETOKEN** - Token da Intellisys na TecnoSpeed, quando for configurar, solicitar a diretoria o token atual.

3. **Boletos Integração**

   **Configurações > Boletos > Boletos Integração**

   Inserir uma nova configuração da integração, a TecnoSpeed, preenchendo as informações solicitadas, todas as informações devem ser obtidas com o cliente, pois são informações do contrato realizado com o banco. No TecnoSpeed será aceito apenas configurações de integração via api do banco, por isso na tela só irá listar os bancos que a TecnoSpeed possui integração via API.

	 - **URL** - Endereço da API da TecnoSpeed `https://plugboleto.com.br/api` para produção `https://homologacao.plugboleto.com.br/api` para homologação;
	 - **ID** - clientID do nosso cliente no webservice do banco
	 - **Secret** - clientSecret do nosso cliente no webservice do banco
	 - **Key** - appKey do nosso cliente no webservice do banco
	 - **Gerar Boleto** - Se estiver marcado é solicitado ao banco a emissão do boleto
	 - **Gerar Pix** - Adiciona o pix ao boleto
	 - **Descrição** - Nome para facilitar a identificação da integração
	 - **Instrução X** - Instruções que serão impressa no boleto, cada instrução ocupara uma linha no boleto.
	 - **Juros** - Descrição do juros no boleto
	 - **Multa** - Descrição da multa no boleto
	 - **Pagamento** - Texto que descreve como pagar o boleto
	 - **Endereço** - Endereço do cedente, da empresa que emite os boletos
	 - **Cedente** - Dados da empresa que emite os boletos
	 - **Agência** - Dados bancários da empresa que emite os boletos
	 - **Código Beneficiário** - Normalmente é o mesmo número da conta sem o dígito
	 - **Carteira** - número da carteira conforme contrato com o banco
	 - **Convênio** - número do convênio com o banco
	 - **Baixa Automática** - Flag que informará ao banco que os boleto terão baixa automática depois de x dias.
	 - **Dias para Baixa** - Quantidade de dias para o banco baixar o boleto automaticamente, o valor máximo é `99`.
	 - **URL WebHook** - url do webhook que receberá as atualizações dos boletos, o endpoit padrão é `{url}/webhook/tecnospeed`
	 - **WebHook** - Status do webhook, dessa forma o webhook pode ser desativado usando esse campo.
	 - **E-mails** - lista de emails separados por `;` que receberão notificação caso algo errado aconteça com os boletos.

4. **Organizador**

   **Configurações > Organizador > Organizador**

   Na aba `Grupo de Faturas`, selecionar no campo integração a opção TecnoSpeed, que foi configurada anteriormente.

5. **Evento Comunicado Automático**

   **Configurações > Evento Comunicado Automático**

   Inserir um novo Evento Comunicado Automático do tipo `42 - Registra fatura banco via integração`. Esse evento é simples, necessitando apenas configurar a hora de execução. A periodicidade será sempre diária, e o evento pode ser o básico porque não teremos envio de mensagem nesse evento, e possui apenas um parâmetro, a `Quantidade de dias para o envio do arquivo após o fechamento do faturamento`.
	 Insira também o evento `43 - Consulta fatura banco via integração`, recomendamos ser por hora para buscar as informações com a TecnoSpeed dos boletos que ainda não foi sincronizado pelo webhook, por erro ou se o webhook estiver desligado.

### Configuração Zenvia Email

1. **Atualizar Objetos**
   - ICRMWeb:
     - PAGE_FormParametrosEmailSmsUra
   - SenderService
   - WebServicesREST

2. **Parâmetros SENDER**

   **Configurações > Parâmetros > Parâmetros SENDER**

   Selecionar no campo `Envio SMTP` a opção `Zenvia` e configurar os campos de `URL Serviço` e `Chave API`

### Configuração Twilio

1. **Atualizar Objetos**
   - ICRMWeb:
     - PAGE_FormParametrosEmailSmsUra
   - SenderService
   - WebServicesREST

2. **Parâmetros SENDER**

   **Configurações > Parâmetros > Parâmetros SENDER**

   Selecionar no campo `Envio SMS` a opção `8 - Twilio` e configurar os campos de `URL Serviço`, `URL WebHook`,`Account ID` e `Chave API`.

### Configuração PontalTech

1. **Atualizar Objetos**
   - ICRMWeb:
     - PAGE_FormParametrosEmailSmsUra
   - SenderService
   - WebServicesREST

2. **Parâmetros SENDER**

   **Configurações > Parâmetros > Parâmetros SENDER**

   para email, selecionar no campo `Envio SMTP` a opção `3 - PontalTech` e configurar os campos de `End Point API`, `ID Cliente`, `Senha`, `E-mail Origem` e `ID Conta`.
   para sms, selecionar no campo `Envio SMTP` a opção `10 - PontalTech` e configurar os campos de `URL Serviço`, `URL WebHook`, `Usuário`, `Senha` e `Conta`.
